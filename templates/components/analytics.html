<!-- analytics.html -->
<div id="analytics" class="hidden">
    <h1>Library Analytics Dashboard</h1>
    
    <div class="analytics-container">
        <!-- Department Distribution -->
        <div class="analytics-card">
            <h2>Department Distribution</h2>
            <div class="chart-container">
                <canvas id="departmentChart"></canvas>
                <div class="loading-spinner" data-for="departmentChart"></div>
                <div class="chart-error" id="departmentChartError"></div>
            </div>
        </div>

        <!-- Gender Distribution -->
        <div class="analytics-card">
            <h2>Gender Distribution</h2>
            <div class="chart-container">
                <canvas id="genderChart"></canvas>
                <div class="loading-spinner" data-for="genderChart"></div>
                <div class="chart-error" id="genderChartError"></div>
            </div>
        </div>

        <!-- Attendance Patterns -->
        <div class="analytics-card full-width">
            <h2>Attendance Patterns</h2>
            <div class="chart-grid">
                <div class="chart-container">
                    <canvas id="dayOfWeekChart"></canvas>
                    <div class="loading-spinner" data-for="dayOfWeekChart"></div>
                    <div class="chart-error" id="dayOfWeekChartError"></div>
                </div>
                <div class="chart-container">
                    <canvas id="weekOfMonthChart"></canvas>
                    <div class="loading-spinner" data-for="weekOfMonthChart"></div>
                    <div class="chart-error" id="weekOfMonthChartError"></div>
                </div>
                <div class="chart-container">
                    <canvas id="hourOfDayChart"></canvas>
                    <div class="loading-spinner" data-for="hourOfDayChart"></div>
                    <div class="chart-error" id="hourOfDayChartError"></div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Analytics Styles */
        .analytics-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            padding: 20px;
        }

        .analytics-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s ease-in-out;
        }

        .analytics-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .analytics-card h2 {
            color: #1a472a;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .analytics-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-container {
            width: 100%;
            height: 300px;
            position: relative;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #45a049;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none;
        }

        .loading-spinner.active {
            display: block;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .chart-error {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #dc3545;
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 4px;
            width: 80%;
        }

        @media (max-width: 768px) {
            .analytics-container {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <script>
        // Define renderDepartmentChart globally to fix the reference error
        window.renderDepartmentChart = function() {
            AnalyticsDashboard.loadDepartmentChart();
        };

        // Analytics Dashboard Manager
        const AnalyticsDashboard = {
            charts: {},
            initialized: false,

            init() {
                if (this.initialized) return;
                this.initialized = true;
                
                // Set chart defaults
                if (typeof Chart !== 'undefined') {
                    Chart.defaults.font.family = "'Inter', sans-serif";
                    Chart.defaults.color = '#666';
                    Chart.defaults.responsive = true;
                }

                // Initialize charts when analytics section is shown
                this.setupEventListeners();
            },

            setupEventListeners() {
                // Store the original showSection function
                const originalShowSection = window.showSection;
                
                // Override showSection
                window.showSection = function(sectionId) {
                    // Call the original function if it exists
                    if (typeof originalShowSection === 'function') {
                        originalShowSection(sectionId);
                    }
                    
                    // Load charts when analytics section is shown
                    if (sectionId === 'analytics') {
                        AnalyticsDashboard.loadAllCharts();
                    }
                };
            },

            async loadAllCharts() {
                this.showLoading('all');
                try {
                    await Promise.all([
                        this.loadDepartmentChart(),
                        this.loadGenderChart(),
                        this.loadAttendanceCharts()
                    ]);
                } catch (error) {
                    console.error('Error loading charts:', error);
                } finally {
                    this.hideLoading('all');
                }
            },

            showLoading(chartId) {
                const spinners = chartId === 'all' 
                    ? document.querySelectorAll('.loading-spinner')
                    : document.querySelectorAll(`.loading-spinner[data-for="${chartId}"]`);
                spinners.forEach(spinner => spinner.classList.add('active'));
            },

            hideLoading(chartId) {
                const spinners = chartId === 'all'
                    ? document.querySelectorAll('.loading-spinner')
                    : document.querySelectorAll(`.loading-spinner[data-for="${chartId}"]`);
                spinners.forEach(spinner => spinner.classList.remove('active'));
            },

            async fetchData(endpoint) {
                try {
                    const response = await fetch(endpoint);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error(`Error fetching data from ${endpoint}:`, error);
                    throw error;
                }
            },

            createChart(canvasId, config) {
                const canvas = document.getElementById(canvasId);
                if (!canvas) {
                    console.error(`Canvas element ${canvasId} not found`);
                    return null;
                }

                // Destroy existing chart if it exists
                if (this.charts[canvasId]) {
                    this.charts[canvasId].destroy();
                }

                const ctx = canvas.getContext('2d');
                this.charts[canvasId] = new Chart(ctx, config);
                return this.charts[canvasId];
            },

            async loadDepartmentChart() {
                try {
                    this.showLoading('departmentChart');
                    const data = await this.fetchData('/department_data');
                    this.createChart('departmentChart', {
                        type: 'bar',
                        data: {
                            labels: data.map(item => item.department),
                            datasets: [{
                                label: 'Students per Department',
                                data: data.map(item => item.count),
                                backgroundColor: 'rgba(69, 160, 73, 0.6)',
                                borderColor: 'rgba(69, 160, 73, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                } catch (error) {
                    this.showError('departmentChart', error);
                } finally {
                    this.hideLoading('departmentChart');
                }
            },

            async loadGenderChart() {
                try {
                    this.showLoading('genderChart');
                    const data = await this.fetchData('/gender_data');
                    this.createChart('genderChart', {
                        type: 'pie',
                        data: {
                            labels: data.map(item => item.gender),
                            datasets: [{
                                data: data.map(item => item.count),
                                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                } catch (error) {
                    this.showError('genderChart', error);
                } finally {
                    this.hideLoading('genderChart');
                }
            },

            async loadAttendanceCharts() {
                try {
                    const [dayData, weekData, hourData] = await Promise.all([
                        this.fetchData('/attendance_data_dayofweek'),
                        this.fetchData('/attendance_data_weekofmonth'),
                        this.fetchData('/attendance_data_hourofday')
                    ]);

                    this.createAttendanceCharts(dayData, weekData, hourData);
                } catch (error) {
                    console.error('Error loading attendance charts:', error);
                    ['dayOfWeekChart', 'weekOfMonthChart', 'hourOfDayChart'].forEach(chartId => {
                        this.showError(chartId, error);
                    });
                }
            },

            createAttendanceCharts(dayData, weekData, hourData) {
                // Day of Week Chart
                this.createChart('dayOfWeekChart', {
                    type: 'bar',
                    data: {
                        labels: dayData.labels,
                        datasets: [{
                            label: 'Attendance by Day of Week',
                            data: dayData.values,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });

                // Week of Month Chart
                this.createChart('weekOfMonthChart', {
                    type: 'line',
                    data: {
                        labels: weekData.labels,
                        datasets: [{
                            label: 'Attendance by Week of Month',
                            data: weekData.values,
                            borderColor: 'rgba(255, 99, 132, 0.8)',
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });

                // Hour of Day Chart
                this.createChart('hourOfDayChart', {
                    type: 'bar',
                    data: {
                        labels: hourData.labels,
                        datasets: [{
                            label: 'Attendance by Hour of Day',
                            data: hourData.values,
                            backgroundColor: 'rgba(153, 102, 255, 0.6)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            },

            showError(chartId, error) {
                console.error(`Error in ${chartId}:`, error);
                const errorDiv = document.getElementById(`${chartId}Error`);
                if (errorDiv) {
                    errorDiv.textContent = 'Failed to load chart data. Please try again later.';
                    errorDiv.style.display = 'block';
                }
            }
        };

        // Initialize the dashboard when the document is ready
        document.addEventListener('DOMContentLoaded', () => {
            AnalyticsDashboard.init();
        });
    </script>
</div>